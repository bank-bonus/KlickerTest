<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–µ–π—Å—ã: –ü—É—Ç—å –∫ –ú–∏–ª–ª–∏–∞—Ä–¥—É</title>
    <!-- VK Bridge SDK -->
    <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
    <style>
        :root {
            --bg-dark: #09090b;
            --surface: #18181b;
            --primary: #8c52ff;
            
            /* –¶–≤–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ */
            --c-common: #b2bec3;
            --c-rare: #0984e3;
            --c-epic: #a29bfe;
            --c-leg: #ffcc00; 
            --c-myth: #d63031; 
            --c-secret: #ff0055; 
            --c-space: #00e5ff; 
        }

        /* --- GLOBAL & BG --- */
        html, body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(76, 29, 149, 0.15) 0%, transparent 60%),
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Roboto', sans-serif;
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; position: fixed; display: flex; flex-direction: column;
            user-select: none; -webkit-user-select: none; -webkit-tap-highlight-color: transparent;
        }

        button { outline: none; -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.96); }

        /* --- LOADER SCREEN --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #09090b;
            z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s ease; /* –ë—ã—Å—Ç—Ä–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ */
        }
        .loader-logo { font-size: 60px; margin-bottom: 20px; animation: pulseLogo 1.5s infinite alternate; }
        .loader-bar-bg { width: 60%; max-width: 300px; height: 6px; background: #222; border-radius: 10px; overflow: hidden; border: 1px solid #333; }
        .loader-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, var(--primary), #00e5ff); transition: width 0.1s linear; }
        .loader-text { margin-top: 15px; color: #888; font-size: 11px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; }

        @keyframes pulseLogo { 0% { transform: scale(1); filter: drop-shadow(0 0 10px rgba(140, 82, 255, 0.3)); } 100% { transform: scale(1.1); filter: drop-shadow(0 0 25px rgba(140, 82, 255, 0.8)); } }

        /* --- ANIMATIONS --- */
        @keyframes caseFloat {
            0% { transform: translateY(0px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.1); }
            50% { transform: translateY(-6px); box-shadow: 0 15px 30px var(--case-glow); border-color: var(--case-border); }
            100% { transform: translateY(0px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.1); }
        }
        @keyframes shimmer { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(0, 184, 148, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 184, 148, 0); } }
        @keyframes neonSpin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- HEADER & STATS --- */
        .header {
            padding: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            z-index: 50; flex-shrink: 0;
            background: linear-gradient(to bottom, rgba(9,9,11,1) 0%, rgba(9,9,11,0) 100%);
        }
        .stat-card {
            background: rgba(30, 30, 36, 0.6); backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 10px 15px;
            display: flex; flex-direction: column; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .stat-card.money { border-bottom: 2px solid #00b894; }
        .stat-label { font-size: 10px; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 2px; }
        .balance-wrap { display: flex; align-items: center; gap: 8px; }
        .coin-icon { width: 20px; height: 20px; background: #00b894; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; color: #000; box-shadow: 0 0 10px rgba(0, 184, 148, 0.6); }
        .balance-val { font-size: 18px; font-weight: 900; color: white; text-shadow: 0 0 10px rgba(0,184,148,0.3); }

        .stat-card.lvl { border-bottom: 2px solid #a29bfe; }
        .lvl-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; }
        .lvl-val { font-size: 14px; font-weight: 800; color: #a29bfe; }
        .xp-container { width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 10px; overflow: hidden; }
        .xp-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #6c5ce7, #a29bfe); transition: width 0.3s; box-shadow: 0 0 8px #6c5ce7; }

        /* --- AD BTN --- */
        .ad-boost-container { text-align: center; margin-bottom: 10px; flex-shrink: 0; }
        .ad-btn { 
            background: rgba(255, 165, 2, 0.15); border: 1px solid rgba(255, 165, 2, 0.4);
            padding: 6px 16px; border-radius: 20px; 
            color: #ffa502; font-weight: 800; font-size: 10px; cursor: pointer; 
            display: inline-flex; align-items: center; gap: 6px;
            transition: 0.2s;
        }
        .ad-btn:active { background: rgba(255, 165, 2, 0.3); }

        /* --- SCREENS --- */
        .screen { flex: 1; display: none; flex-direction: column; overflow-y: auto; padding-bottom: 20px; -webkit-overflow-scrolling: touch; }
        .active-screen { display: flex; animation: fadeEffect 0.3s; }
        @keyframes fadeEffect { from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);} }

        /* --- CLICKER --- */
        .clicker-container { text-align: center; margin: 10px 0 20px 0; flex-shrink: 0;}
        .work-btn { 
            padding: 12px 35px; font-size: 15px; border-radius: 50px; border: none;
            color: white; font-weight: 900; text-transform: uppercase;
            background: linear-gradient(270deg, #ff2a6d, #ff758c, #ff2a6d);
            background-size: 200% 200%; animation: shimmer 3s ease infinite;
            box-shadow: 0 5px 20px rgba(255, 42, 109, 0.4); 
            display: inline-flex; align-items: center; gap: 8px; transition: transform 0.1s;
        }
        .float-text { position: absolute; color: #00b894; font-weight: 900; font-size: 24px; pointer-events: none; z-index: 9999; animation: floatUp 0.8s ease-out forwards; text-shadow: 0 2px 4px rgba(0,0,0,0.8);}
        @keyframes floatUp { 0% {transform: translateY(0) scale(1); opacity: 1;} 100% {transform: translateY(-80px) scale(1.5); opacity: 0;} }

        /* --- CASES --- */
        .section-title { padding: 0 20px 10px; font-size: 12px; color: #666; text-transform: uppercase; font-weight: 800; letter-spacing: 1px; margin-top: 5px; }
        .case-list { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 0 15px; }
        .case-card { 
            background: linear-gradient(160deg, #25252b, #151518);
            border: 1px solid rgba(255,255,255,0.05); border-radius: 18px; padding: 20px 5px; 
            text-align: center; position: relative; 
            --case-glow: rgba(255,255,255,0.2); --case-border: rgba(255,255,255,0.1);
            animation: caseFloat 4s ease-in-out infinite; transition: transform 0.1s;
        }
        .case-card:active { transform: scale(0.95); }
        .case-card:nth-child(even) { animation-delay: 2s; }
        .case-img-icon { width: 75px; height: 75px; object-fit: contain; margin: 5px 0 10px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5)); pointer-events: none; display: block; margin-left: auto; margin-right: auto;}
        .case-name { font-weight: 700; font-size: 13px; margin-bottom: 6px; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .case-price { background: rgba(0,0,0,0.5); padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #ffcc00; font-weight: bold; display: inline-block; border: 1px solid rgba(255, 204, 0, 0.15); }

        /* --- SHOP --- */
        .shop-list { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .shop-item { background: var(--surface); border: 1px solid #333; border-radius: 14px; padding: 12px; display: flex; align-items: center; gap: 12px; }
        .shop-item.locked { opacity: 0.5; filter: grayscale(1); }
        .shop-icon-box { 
            width: 44px; height: 44px; background: rgba(255,255,255,0.03); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .shop-icon-img { width: 30px; height: 30px; object-fit: contain; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
        .buy-btn { background: #6c5ce7; color: white; border: none; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 11px; min-width: 75px; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3);}
        .buy-btn.disabled { background: #333; color: #555; pointer-events: none; box-shadow: none; }

        /* --- INVENTORY --- */
        .inv-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 15px; }
        .inv-card { background: var(--surface); padding: 8px; border-radius: 10px; text-align: center; border: 1px solid #333; }
        .inv-card img { width: 45px; height: 45px; object-fit: contain; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.3));}
        .inv-sell { width: 100%; margin-top: 5px; background: rgba(0, 255, 157, 0.1); color: #00b894; border: 1px solid rgba(0, 255, 157, 0.3); border-radius: 4px; font-size: 9px; padding: 4px; font-weight: bold; cursor: pointer;}

        /* --- GAME WINDOW --- */
        #game-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f0f13; z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: #222; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;}
        .roulette-wrapper { width: 100%; height: 130px; background: #050505; margin: 25px 0; border-top: 2px solid #6c5ce7; border-bottom: 2px solid #6c5ce7; position: relative; overflow: hidden; box-shadow: 0 0 40px rgba(108, 92, 231, 0.3); flex-shrink: 0; }
        .pointer { position: absolute; top: 0; bottom: 0; left: 50%; transform: translateX(-50%); width: 4px; background: #d63031; z-index: 10; box-shadow: 0 0 15px #d63031; }
        .tape { display: flex; height: 100%; align-items: center; }
        .tape-item { width: 90px; min-width: 90px; height: 90px; margin: 0 4px; background: #18181b; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: inset 0 0 15px rgba(0,0,0,0.5); }
        .tape-item img { width: 60px; height: 60px; object-fit: contain; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }
        .spin-button-main { background: linear-gradient(90deg, #00b894, #00cec9); border: none; padding: 12px 40px; border-radius: 50px; color: white; font-size: 16px; font-weight: 900; letter-spacing: 1px; animation: pulseGlow 2s infinite; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .spin-button-main:active { transform: scale(0.95); animation: none; }
        .spin-button-main:disabled { filter: grayscale(1); opacity: 0.5; animation: none; }

        /* --- MODALS --- */
        .modal-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index: 4000; align-items:center; justify-content:center; flex-direction:column; backdrop-filter: blur(5px); }
        .prize-card-wrap { position: relative; padding: 4px; border-radius: 24px; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .prize-card-wrap::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: conic-gradient(transparent, #8c52ff, #00e5ff, #d300ff, transparent 30%); animation: neonSpin 3s linear infinite; }
        .prize-card { position: relative; background: #18181b; padding: 25px; border-radius: 20px; text-align: center; width: 240px; z-index: 2; }
        .prize-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 10px; filter: drop-shadow(0 0 15px rgba(255,255,255,0.1)); }
        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .act-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; color: white; font-weight: bold; font-size: 12px; cursor: pointer; text-transform: uppercase;}
        .simple-card { background: #18181b; padding: 25px; border-radius: 20px; text-align: center; width: 260px; border: 1px solid #333; box-shadow: 0 10px 40px rgba(0,0,0,0.5); animation: popIn 0.3s ease; }
        @keyframes popIn { from {transform: scale(0.8); opacity:0;} to {transform: scale(1); opacity:1;} }

        /* --- NAVBAR --- */
        .nav-bar { background: #16161a; border-top: 1px solid #333; padding: 8px 0; display: flex; justify-content: space-around; z-index: 100; flex-shrink: 0; padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        .nav-item { background: none; border: none; color: #555; font-size: 10px; font-weight: bold; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; width: 33%; transition: color 0.2s; }
        .nav-icon { width: 24px; height: 24px; object-fit: contain; filter: grayscale(100%) opacity(0.6); transition: 0.3s; }
        .nav-item.active { color: #8c52ff; }
        .nav-item.active .nav-icon { filter: grayscale(0%) opacity(1) drop-shadow(0 0 5px #8c52ff); transform: scale(1.1); }

        /* --- RARITY BORDERS --- */
        .r-1 { border-color: var(--c-common); } .r-2 { border-color: var(--c-rare); box-shadow: inset 0 0 10px rgba(9, 132, 227, 0.2); } .r-3 { border-color: var(--c-epic); box-shadow: inset 0 0 10px rgba(162, 155, 254, 0.2); }
        .r-4 { border-color: #e84393; box-shadow: inset 0 0 10px rgba(232, 67, 147, 0.2); } .r-5 { border-color: var(--c-leg); box-shadow: inset 0 0 15px rgba(255, 204, 0, 0.2); }
        .r-6 { border-color: var(--c-myth); box-shadow: inset 0 0 15px rgba(214, 48, 49, 0.3); background: radial-gradient(circle, #222, #000); }
        .r-7 { border-color: var(--c-space); box-shadow: inset 0 0 15px rgba(0, 229, 255, 0.2); } .r-8 { border-color: var(--c-secret); box-shadow: inset 0 0 20px rgba(255, 0, 85, 0.3); background: radial-gradient(circle, #330011, #000); }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="loader">
        <div class="loader-logo">üì¶</div>
        <div class="loader-bar-bg"><div class="loader-bar-fill" id="loader-bar"></div></div>
        <div class="loader-text" id="loader-text">–ó–ê–ì–†–£–ó–ö–ê –†–ï–°–£–†–°–û–í... 0%</div>
    </div>

    <!-- HEADER -->
    <div class="header">
        <div class="stat-card money">
            <div class="stat-label">–ë–∞–ª–∞–Ω—Å</div>
            <div class="balance-wrap"><div class="coin-icon">$</div><div class="balance-val" id="ui-balance">0</div></div>
        </div>
        <div class="stat-card lvl">
            <div class="lvl-header"><div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div><div class="lvl-val" id="ui-lvl">1</div></div>
            <div class="xp-container"><div class="xp-fill" id="ui-xp"></div></div>
        </div>
    </div>

    <!-- Ad Boost -->
    <div class="ad-boost-container">
        <button type="button" class="ad-btn" onclick="watchAdBoost()">
            <svg style="width:10px;height:10px;fill:#ffa502" viewBox="0 0 384 512"><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg> 
            –ë–£–°–¢ x2 <span id="boost-timer" style="margin-left:5px; color:#fff; display:none"></span>
        </button>
        <div style="font-size:10px;color:#666;margin-top:2px">–î–æ—Ö–æ–¥: <span id="ui-income">0</span>/—Å–µ–∫</div>
    </div>

    <!-- SCREENS -->
    <div id="screen-home" class="screen active-screen">
        <div class="clicker-container">
            <button class="work-btn" onclick="doWork(event)">
                <svg style="width:16px;height:16px;fill:white" viewBox="0 0 448 512"><path d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z"/></svg>
                –ö–õ–ò–ö (+1$)
            </button>
        </div>
        <div class="section-title">–ú–∞–≥–∞–∑–∏–Ω –ö–µ–π—Å–æ–≤</div>
        <div class="case-list" id="case-list"></div>
    </div>

    <div id="screen-shop" class="screen">
        <div style="padding: 15px; text-align: center;">
            <h3 style="margin:0; text-transform: uppercase; letter-spacing: 1px;">–ë–∏–∑–Ω–µ—Å –ò–º–ø–µ—Ä–∏—è</h3>
            <p style="color:#666; font-size: 11px;">–ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥ —Ç—Ä–µ–±—É–µ—Ç —É—Ä–æ–≤–Ω—è</p>
        </div>
        <div class="shop-list" id="shop-list"></div>
    </div>

    <div id="screen-inv" class="screen">
        <div style="padding: 15px; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin:0">–°–∫–ª–∞–¥</h3>
            <button onclick="sellAll()" style="background:#d63031; color:white; border:none; padding:8px 15px; border-radius:8px; font-size:11px; font-weight:bold;">–ü—Ä–æ–¥–∞—Ç—å –≤—Å—ë</button>
        </div>
        <div class="inv-grid" id="inv-grid"></div>
    </div>

    <!-- GAME WINDOW -->
    <div id="game-overlay">
        <button class="close-btn" onclick="closeGame()">‚úï</button>
        <h2 id="game-title" style="margin-bottom: 5px; font-size: 24px; text-transform: uppercase; letter-spacing: 1px;">–ö–µ–π—Å</h2>
        <div id="game-price" style="color:#888; margin-bottom: 20px; font-size: 14px;">0 $</div>
        <div class="roulette-wrapper"><div class="pointer"></div><div class="tape" id="tape"></div></div>
        <button class="spin-button-main" id="spin-btn" onclick="spin()">–ö–†–£–¢–ò–¢–¨</button>
    </div>

    <!-- WIN MODAL -->
    <div id="win-modal" class="modal-overlay">
        <div class="prize-card-wrap">
            <div class="prize-card" id="prize-card-inner">
                <h3 style="color:#aaa; margin-top:0; font-size:11px; text-transform: uppercase;">–í—ã –≤—ã–∏–≥—Ä–∞–ª–∏</h3>
                <img src="" class="prize-img" id="prize-img">
                <h2 id="prize-name" style="margin: 0; font-size: 18px; text-transform: uppercase;">Item</h2>
                <p id="prize-price" style="color: #00b894; font-weight: 900; font-size: 16px; margin: 5px 0 0;">100 $</p>
                <div class="action-btns">
                    <button class="act-btn" style="background: #2d3436; border: 1px solid #555;" onclick="takeItem()">–í –°–ö–õ–ê–î</button>
                    <button class="act-btn" style="background: #00b894; color: #000;" onclick="sellItem()">–ü–†–û–î–ê–¢–¨</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-generic" class="modal-overlay"><div class="simple-card" id="modal-content"></div></div>

    <!-- NAVBAR -->
    <div class="nav-bar">
        <button class="nav-item active" onclick="setTab('home', this)">
            <img src="https://cdn-icons-png.flaticon.com/512/9328/9328963.png" class="nav-icon" alt="Cases">
            <span>–ö–µ–π—Å—ã</span>
        </button>
        <button class="nav-item" onclick="setTab('shop', this)">
            <img src="https://cdn-icons-png.flaticon.com/512/2910/2910768.png" class="nav-icon" alt="Business">
            <span>–ë–∏–∑–Ω–µ—Å</span>
        </button>
        <button class="nav-item" onclick="setTab('inv', this)">
            <img src="https://cdn-icons-png.flaticon.com/512/2897/2897785.png" class="nav-icon" alt="Inventory">
            <span>–°–∫–ª–∞–¥</span>
        </button>
    </div>

    <script>
        vkBridge.send('VKWebAppInit');
        function hapticLight() { if(vkBridge.supports("VKWebAppTapticImpactOccurred")) vkBridge.send("VKWebAppTapticImpactOccurred", {"style": "light"}); }
        function hapticHeavy() { if(vkBridge.supports("VKWebAppTapticImpactOccurred")) vkBridge.send("VKWebAppTapticImpactOccurred", {"style": "heavy"}); }
        function hapticSuccess() { if(vkBridge.supports("VKWebAppTapticNotificationOccurred")) vkBridge.send("VKWebAppTapticNotificationOccurred", {"type": "success"}); }

        // --- DATA VARIABLES ---
        let balance = 0, inventory = [], myBiz = [0,0,0,0,0,0,0,0], income = 0, level = 1, xp = 0, xpToNext = 500, boostEndTime = 0;
        let isDataLoaded = false; // –í–∞–∂–Ω—ã–π —Ñ–ª–∞–≥ –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π

        // ITEMS
        const items = {
            trash: [ {n:"–°—Ç–∏–∫–µ—Ä", p:2, r:1, i:"sticker.png"}, {n:"–ë—Ä–µ–ª–æ–∫", p:5, r:1, i:"sock.png"}, {n:"–§–∞–Ω—Ç–∏–∫", p:1, r:1, i:"paper.png"}, {n:"–ö–∞–º–µ–Ω—å", p:3, r:1, i:"stone.png"}, {n:"–°–∫—Ä–µ–ø–∫–∞", p:4, r:1, i:"clip.png"}, {n:"–ü—É–≥–æ–≤–∏—Ü–∞", p:2, r:1, i:"button.png"}, {n:"–®–Ω—É—Ä–æ–∫", p:3, r:1, i:"lace.png"} ],
            common: [ {n:"–ù–∞—É—à–Ω–∏–∫–∏", p:20, r:2, i:"headphones.png"}, {n:"–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞", p:40, r:2, i:"keyboard.png"}, {n:"–§–ª–µ—à–∫–∞", p:15, r:2, i:"usb.png"}, {n:"–ú—ã—à–∫–∞", p:25, r:2, i:"mouse.png"}, {n:"–§—É—Ç–±–æ–ª–∫–∞", p:30, r:2, i:"tshirt.png"}, {n:"–ö–µ–ø–∫–∞", p:35, r:2, i:"cap.png"}, {n:"–ö—Ä—É–∂–∫–∞", p:10, r:2, i:"mug.png"} ],
            rare: [ {n:"iPhone 15", p:120, r:3, i:"iphone.png"}, {n:"PS5", p:80, r:3, i:"ps5.png"}, {n:"–ß–∞—Å—ã", p:100, r:3, i:"watch.png"}, {n:"–ü–ª–∞–Ω—à–µ—Ç", p:150, r:3, i:"tablet.png"}, {n:"–î—Ä–æ–Ω", p:200, r:3, i:"drone.png"}, {n:"–ö–æ–ª–æ–Ω–∫–∞", p:90, r:3, i:"speaker.png"}, {n:"–ö–∞–º–µ—Ä–∞", p:180, r:3, i:"camera.png"} ],
            epic: [ {n:"MacBook", p:300, r:4, i:"macbook.png"}, {n:"PC", p:500, r:4, i:"pc.png"}, {n:"–°–∞–º–æ–∫–∞—Ç", p:400, r:4, i:"scooter.png"}, {n:"–ö—Ä–µ—Å–ª–æ", p:350, r:4, i:"chair.png"}, {n:"–ú–æ–Ω–∏—Ç–æ—Ä", p:450, r:4, i:"monitor.png"}, {n:"–ö–æ–ª—å—Ü–æ", p:600, r:4, i:"ring.png"}, {n:"–°—É–º–∫–∞", p:700, r:4, i:"bag.png"} ],
            leg: [ {n:"Tesla", p:5000, r:5, i:"tesla.png"}, {n:"–í–∏–ª–ª–∞", p:15000, r:5, i:"house.png"}, {n:"–ë–∞–π–∫", p:8000, r:5, i:"bike.png"}, {n:"–°–ª–∏—Ç–æ–∫", p:10000, r:5, i:"goldbar.png"}, {n:"–ö–≤–∞–¥—Ä–æ—Ü–∏–∫–ª", p:6000, r:5, i:"quad.png"}, {n:"–†–æ–ª–µ–∫—Å—ã", p:12000, r:5, i:"rolex.png"}, {n:"–í–∞–∑–∞", p:9000, r:5, i:"vase.png"} ],
            god: [ {n:"–Ø—Ö—Ç–∞", p:25000, r:6, i:"yacht.png"}, {n:"–°–∞–º–æ–ª–µ—Ç", p:80000, r:6, i:"plane.png"}, {n:"–í–µ—Ä—Ç–æ–ª–µ—Ç", p:40000, r:6, i:"heli.png"}, {n:"–û—Å–æ–±–Ω—è–∫", p:60000, r:6, i:"mansion.png"}, {n:"–û—Å—Ç—Ä–æ–≤", p:90000, r:6, i:"island.png"}, {n:"–ü–æ–µ–∑–¥", p:70000, r:6, i:"train.png"}, {n:"–õ–∏–º—É–∑–∏–Ω", p:30000, r:6, i:"limo.png"} ],
            mythic: [ {n:"–ë–∏—Ç–∫–æ–∏–Ω", p:40000, r:7, i:"bitcoin.png"}, {n:"–°–µ—Ä–≤–µ—Ä–Ω–∞—è", p:120000, r:7, i:"server.png"}, {n:"–ò–ò –Ø–¥—Ä–æ", p:150000, r:7, i:"ai_core.png"}, {n:"–ö–≤–∞–Ω—Ç. —á–∏–ø", p:110000, r:7, i:"chip.png"}, {n:"–†–æ–±–æ—Ç", p:130000, r:7, i:"robot.png"}, {n:"–õ–∞–∑–µ—Ä", p:140000, r:7, i:"laser.png"}, {n:"–≠–∫–∑–æ—Å–∫–µ–ª–µ—Ç", p:160000, r:7, i:"exo.png"} ],
            cosmic: [ {n:"–ú–ö–°", p:200000, r:8, i:"iss.png"}, {n:"–ë–∞–∑–∞ –õ—É–Ω–∞", p:500000, r:8, i:"moonbase.png"}, {n:"–ú–∞—Ä—Å–æ—Ö–æ–¥", p:250000, r:8, i:"rover.png"}, {n:"–°–ø—É—Ç–Ω–∏–∫", p:220000, r:8, i:"satellite.png"}, {n:"–ù–õ–û", p:400000, r:8, i:"ufo.png"}, {n:"–°–∫–∞—Ñ–∞–Ω–¥—Ä", p:300000, r:8, i:"spacesuit.png"}, {n:"–ó–≤–µ–∑–¥–∞", p:1000000, r:8, i:"star_shard.png"} ]
        };

        const cases = [
            { id:0, n:"–°—Ç–∞—Ä—Ç–æ–≤—ã–π", p:10, i:"case_1.png", pool:[...items.trash, ...items.common], w:[80,20], xp:5, colorVar: '--c-common' },
            { id:1, n:"–ü—Ä–æ—Ñ–∏", p:100, i:"case_2.png", pool:[...items.common, ...items.rare, ...items.epic], w:[60,30,10], xp:20, colorVar: '--c-rare' },
            { id:2, n:"–ú–∞–∂–æ—Ä", p:1000, i:"case_3.png", pool:[...items.rare, ...items.epic, ...items.leg], w:[60,25,15], xp:50, colorVar: '--c-epic' },
            { id:3, n:"–û–ª–∏–≥–∞—Ä—Ö", p:50000, i:"case_4.png", pool:[...items.leg, ...items.god, ...items.mythic], w:[50,40,10], xp:200, colorVar: '--c-leg' },
            { id:4, n:"–ö–æ—Å–º–æ—Å", p:250000, i:"case_5.png", pool:[...items.god, ...items.mythic, ...items.cosmic], w:[50,45,5], xp:1000, colorVar: '--c-space' },
            { id:5, n:"–°–ï–ö–†–ï–¢–ù–´–ô", p:10000000, i:"case_6.png", pool:[...items.mythic, ...items.cosmic], w:[40,60], xp:5000, colorVar: '--c-secret' }
        ];

        const bizList = [
            { n:"–õ–∞—Ä–µ–∫", p:50, inc:1, reqLvl: 1, img: "https://cdn-icons-png.flaticon.com/512/1069/1069102.png" }, 
            { n:"–¢–∞–∫—Å–∏", p:250, inc:5, reqLvl: 2, img: "https://cdn-icons-png.flaticon.com/512/2555/2555013.png" }, 
            { n:"–ö–∞—Ñ–µ", p:1200, inc:20, reqLvl: 3, img: "https://cdn-icons-png.flaticon.com/512/924/924514.png" },
            { n:"–ú–∞–π–Ω–∏–Ω–≥", p:5000, inc:70, reqLvl: 5, img: "https://cdn-icons-png.flaticon.com/512/2040/2040520.png" },
            { n:"–ó–∞–≤–æ–¥", p:20000, inc:300, reqLvl: 7, img: "https://cdn-icons-png.flaticon.com/512/2897/2897785.png" },
            { n:"–ë–∞–Ω–∫", p:150000, inc:2000, reqLvl: 10, img: "https://cdn-icons-png.flaticon.com/512/2534/2534204.png" },
            { n:"–ù–µ—Ñ—Ç—å", p:1000000, inc:10000, reqLvl: 15, img: "https://cdn-icons-png.flaticon.com/512/2424/2424590.png" },
            { n:"–ö–æ—Å–º–æ–¥—Ä–æ–º", p:50000000, inc:150000, reqLvl: 25, img: "https://cdn-icons-png.flaticon.com/512/1067/1067357.png" }
        ];

        // --- PRELOAD & INIT ---
        function startPreloadAndData() {
            // 1. –°–Ω–∞—á–∞–ª–∞ –≥—Ä—É–∑–∏–º –ö–ï–ô–°–´ (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∞)
            let criticalImages = [];
            cases.forEach(c => criticalImages.push(c.i));
            
            let total = criticalImages.length;
            let loaded = 0;
            let bar = document.getElementById('loader-bar');
            let txt = document.getElementById('loader-text');

            // –ó–∞—â–∏—Ç–∞: —á–µ—Ä–µ–∑ 3 —Å–µ–∫ —É–±–∏—Ä–∞–µ–º –ª–æ–∞–¥–µ—Ä, –¥–∞–∂–µ –µ—Å–ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
            let safetyTimer = setTimeout(finishLoading, 3000); 

            if(total === 0) { finishLoading(); return; }

            criticalImages.forEach(src => {
                let img = new Image();
                img.src = src;
                img.onload = onImgLoad;
                img.onerror = onImgLoad;
            });

            function onImgLoad() {
                loaded++;
                let pct = Math.floor((loaded/total) * 100);
                bar.style.width = pct + "%";
                txt.innerText = "–ó–ê–ì–†–£–ó–ö–ê... " + pct + "%";
                if(loaded >= total) finishLoading();
            }

            function finishLoading() {
                clearTimeout(safetyTimer);
                hideLoader();
                // 2. –ü–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è –ª–æ–∞–¥–µ—Ä–∞ –≥—Ä—É–∑–∏–º –î–ê–ù–ù–´–ï –ò–ó –í–ö
                loadData(); 
            }
        }

        function hideLoader() {
            let l = document.getElementById('loader');
            l.style.opacity = 0;
            setTimeout(() => { l.style.display = 'none'; }, 300);
        }

        // --- CORE FUNCTIONS (Render Immediately!) ---
        function renderCases() {
            let c = document.getElementById('case-list'); c.innerHTML='';
            cases.forEach(item => {
                let d = document.createElement('div'); d.className = 'case-card';
                d.style.setProperty('--case-glow', `var(${item.colorVar})`);
                d.style.setProperty('--case-border', `var(${item.colorVar})`);
                d.onclick = () => { hapticLight(); openGame(item.id); };
                d.innerHTML = `
                    <img src="${item.i}" class="case-img-icon" alt="${item.n}">
                    <div class="case-name">${item.n}</div>
                    <div class="case-price" style="color:var(${item.colorVar})">${item.p.toLocaleString()} $</div>
                `;
                c.appendChild(d);
            });
        }

        function renderShop() {
            let c = document.getElementById('shop-list'); c.innerHTML='';
            bizList.forEach((b, i) => {
                let count = myBiz[i] || 0;
                let price = Math.floor(b.p * Math.pow(1.15, count));
                let isLocked = level < b.reqLvl;
                let div = document.createElement('div'); 
                div.className = `shop-item ${isLocked ? 'locked' : ''}`;
                div.innerHTML = `
                    <div class="shop-icon-box"><img src="${b.img}" class="shop-icon-img"></div>
                    <div class="shop-info">
                        <div style="font-weight:bold; color:white; font-size:13px">${b.n}</div>
                        <div style="font-size:10px; color:#888">+${b.inc}/—Å–µ–∫ | –ï—Å—Ç—å: ${count}</div>
                    </div>
                    <button class="buy-btn ${balance>=price && !isLocked ?'':'disabled'}" onclick="buyBiz(${i})">${isLocked ? 'LVL '+b.reqLvl : price.toLocaleString()+' $'}</button>
                `;
                c.appendChild(div);
            });
        }

        // --- STORAGE LOGIC ---
        function loadData() {
            vkBridge.send('VKWebAppStorageGet', { keys: ['save_data'] })
                .then(data => {
                    if (data.keys && data.keys.length > 0 && data.keys[0].value) {
                        try {
                            const d = JSON.parse(data.keys[0].value);
                            balance = d.b || 0; inventory = d.i || []; myBiz = d.z || [0,0,0,0,0,0,0,0];
                            level = d.l || 1; xp = d.x || 0; boostEndTime = d.bt || 0; calcXpNeeded();
                        } catch(e) { console.error(e); }
                    } else { balance = 20; }
                    
                    isDataLoaded = true; // –†–ê–ó–†–ï–®–ê–ï–ú –°–û–•–†–ê–ù–ï–ù–ò–ï
                    updateUI();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫, –Ω–æ –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∏–ª–∏—Å—å
                    setInterval(saveData, 5000);
                })
                .catch(() => { 
                    balance = 20; isDataLoaded = true; updateUI(); 
                    setInterval(saveData, 5000);
                });
        }

        function saveData() {
            if (!isDataLoaded) return; // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å—Ç–∏—Ä–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            const data = { b:balance, i:inventory, z:myBiz, l:level, x:xp, bt:boostEndTime };
            vkBridge.send('VKWebAppStorageSet', { key: 'save_data', value: JSON.stringify(data) });
        }

        // --- GAME LOGIC ---
        function calcXpNeeded() { xpToNext = level * 800; }
        
        function addXp(amount) {
            xp += amount;
            if(xp >= xpToNext) {
                xp -= xpToNext; level++; calcXpNeeded();
                showModal("–£–†–û–í–ï–ù–¨ –ü–û–í–´–®–ï–ù!", `–¢–µ–ø–µ—Ä—å —Ç—ã Level ${level}`, "–ö–†–£–¢–û");
                hapticSuccess();
            }
            updateUI();
        }

        function calcIncome() { 
            let t=0; myBiz.forEach((c,i) => { if(bizList[i]) t += c * bizList[i].inc; });
            let now = Date.now();
            if(now < boostEndTime) {
                t = t * 2; document.getElementById('boost-timer').style.display = 'inline';
                let left = Math.ceil((boostEndTime - now)/1000);
                document.getElementById('boost-timer').innerText = `(${left}s)`;
            } else { document.getElementById('boost-timer').style.display = 'none'; }
            income=t; document.getElementById('ui-income').innerText = t.toLocaleString(); 
        }

        setInterval(() => { if(income>0) { balance+=income; updateUI(); } calcIncome(); }, 1000);

        function updateUI() { 
            document.getElementById('ui-balance').innerText = Math.floor(balance).toLocaleString(); 
            document.getElementById('ui-lvl').innerText = level;
            let pct = (xp / xpToNext) * 100;
            document.getElementById('ui-xp').style.width = pct + "%";
            if(document.getElementById('screen-shop').classList.contains('active-screen')) renderShop();
        }

        function setTab(name, btn) {
            hapticLight();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById('screen-'+name).classList.add('active-screen');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(name==='inv') renderInv();
            if(name==='shop') renderShop();
            if(name==='home') renderCases();
        }

        function watchAdBoost() {
            vkBridge.send("VKWebAppShowRewardedAd").then(data => {
                if (data.result) {
                    boostEndTime = Date.now() + (180 * 1000);
                    calcIncome();
                    showModal("–ë–£–°–¢ –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!", "–î–æ—Ö–æ–¥ x2 –Ω–∞ 3 –º–∏–Ω—É—Ç—ã.", "–û–¢–õ–ò–ß–ù–û");
                    hapticSuccess();
                }
            });
        }

        function doWork(e) {
            balance += 1; addXp(1); updateUI(); hapticLight();
            let b = document.getElementById('ui-balance'); b.style.transform = "scale(1.2)"; setTimeout(()=>b.style.transform="scale(1)", 100);
            let float = document.createElement('div'); float.className = 'float-text'; float.innerText = "+1 $";
            let rect = e.target.getBoundingClientRect();
            let x = e.clientX || rect.left + rect.width/2; let y = e.clientY || rect.top;
            float.style.left = x + 'px'; float.style.top = y + 'px';
            document.body.appendChild(float); setTimeout(() => float.remove(), 800);
        }

        function buyBiz(i) {
            let b = bizList[i];
            let price = Math.floor(b.p * Math.pow(1.15, myBiz[i] || 0));
            if(balance >= price) { 
                balance-=price; if(!myBiz[i]) myBiz[i]=0; myBiz[i]++; 
                calcIncome(); updateUI(); saveData(); hapticSuccess();
            }
        }

        let currCase = null; let wonItem = null;
        function openGame(id) {
            currCase = cases[id];
            document.getElementById('game-overlay').style.display = 'flex';
            document.getElementById('game-title').innerText = currCase.n;
            document.getElementById('game-title').style.color = `var(${currCase.colorVar})`;
            document.getElementById('game-price').innerText = currCase.p.toLocaleString() + " $";
            initTape(currCase);
        }
        function closeGame() { document.getElementById('game-overlay').style.display = 'none'; }
        
        function createTapeItem(item) {
            let d = document.createElement('div'); d.className = `tape-item r-${item.r}`;
            d.innerHTML = `<img src="${item.i}">`;
            return d;
        }

        function getRandomItemFromCase(c) {
            let rnd = Math.random() * 100; let wSum = 0; let idx = 0;
            for(let i=0; i < c.w.length; i++) { wSum += c.w[i]; if(rnd <= wSum) { idx = i; break; } }
            let pool = c.pool; return pool[Math.floor(Math.random() * pool.length)];
        }

        function initTape(c) {
            let t = document.getElementById('tape'); t.innerHTML=''; t.style.transition='none'; t.style.transform='translateX(0)';
            for(let i=0; i<30; i++) t.appendChild(createTapeItem(c.pool[Math.floor(Math.random()*c.pool.length)]));
        }

        function spin() {
            if(balance < currCase.p) { showModal("–ù–µ—Ç –¥–µ–Ω–µ–≥", "–ü–æ–∫–ª–∏–∫–∞–π –∏–ª–∏ –∂–¥–∏ –¥–æ—Ö–æ–¥–∞", "OK"); return; }
            balance -= currCase.p; addXp(currCase.xp || 5); updateUI(); saveData(); hapticHeavy();
            let btn = document.getElementById('spin-btn'); btn.disabled = true; 
            let winner = getRandomItemFromCase(currCase); wonItem = winner;
            let t = document.getElementById('tape'); t.innerHTML=''; t.style.transition='none'; t.style.transform='translateX(0)';
            for(let i=0; i<45; i++) t.appendChild(createTapeItem(currCase.pool[Math.floor(Math.random()*currCase.pool.length)]));
            t.appendChild(createTapeItem(winner));
            for(let i=0; i<10; i++) t.appendChild(createTapeItem(currCase.pool[Math.floor(Math.random()*currCase.pool.length)]));
            setTimeout(() => {
                let cardW = 98; let offset = Math.floor(Math.random() * 60) - 30; 
                let pos = (45 * cardW) - (t.parentElement.offsetWidth / 2) + (cardW / 2) + offset;
                t.style.transition = "transform 4s cubic-bezier(0.1, 0, 0.2, 1)";
                t.style.transform = `translateX(-${pos}px)`;
                setTimeout(() => { showWin(winner); }, 4000);
            }, 50);
        }

        function showWin(item) {
            hapticSuccess();
            document.getElementById('prize-img').src = item.i;
            document.getElementById('prize-name').innerText = item.n;
            document.getElementById('prize-price').innerText = item.p.toLocaleString() + " $";
            document.getElementById('win-modal').style.display = 'flex';
        }

        function sellItem() { balance += wonItem.p; updateUI(); saveData(); reset(); }
        function takeItem() { inventory.push(wonItem); saveData(); reset(); }
        function reset() {
            document.getElementById('win-modal').style.display = 'none';
            document.getElementById('spin-btn').disabled = false;
            initTape(currCase);
        }

        function renderInv() {
            let g = document.getElementById('inv-grid'); g.innerHTML='';
            if(!inventory.length) { g.innerHTML=`<div style="grid-column:span 3;text-align:center;color:#666;font-size:12px">–ü—É—Å—Ç–æ</div>`; return; }
            inventory.forEach((it, i) => {
                let d = document.createElement('div'); d.className = `inv-card r-${it.r}`;
                d.innerHTML = `<img src="${it.i}"><div style="font-size:9px;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${it.n}</div><button class="inv-sell" onclick="sellOne(${i})">+${it.p}$</button>`;
                g.appendChild(d);
            });
        }
        function sellOne(i) { balance+=inventory[i].p; inventory.splice(i,1); updateUI(); saveData(); renderInv(); hapticLight(); }
        
        function sellAll() { 
            if(!inventory.length) return;
            let sum=0; inventory.forEach(x=>sum+=x.p); balance+=sum; inventory=[];
            updateUI(); saveData(); renderInv(); hapticSuccess();
        }

        function showModal(title, text, btnText) {
            document.getElementById('modal-content').innerHTML = `
                <h3 style="margin:0 0 10px; color:white">${title}</h3>
                <p style="color:#aaa; margin:0 0 15px; font-size:13px">${text}</p>
                <button class="act-btn" style="background:#6c5ce7; width:100%" onclick="document.getElementById('modal-generic').style.display='none'">${btnText}</button>
            `;
            document.getElementById('modal-generic').style.display = 'flex';
        }

        // --- INIT SEQUENCE (–ú–ì–ù–û–í–ï–ù–ù–ê–Ø –û–¢–†–ò–°–û–í–ö–ê) ---
        // 1. –°—Ä–∞–∑—É —Ä–∏—Å—É–µ–º –º–µ–Ω—é (–ø—É—Å—Ç—å –¥–∞–∂–µ –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö), —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ø—É—Å—Ç–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
        renderCases();
        renderShop();
        
        // 2. –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ –¥–∞–Ω–Ω—ã—Ö
        startPreloadAndData();
    </script>
</body>
        </html>
